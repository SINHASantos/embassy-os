<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <pwa-back-button></pwa-back-button>
    </ion-buttons>
    <ion-title>Service Details</ion-title>
    <ion-buttons slot="end">
      <badge-menu-button></badge-menu-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding-bottom">

  <ion-item *ngIf="error" style="margin-bottom: 16px;">
    <ion-text class="ion-text-wrap" color="danger">{{ error }}</ion-text>
  </ion-item>

  <div class="top-plate">
    <ion-item class="no-cushion-item" lines="none">
      <ion-label class="ion-text-wrap" style="
        display: grid;
        grid-template-columns: 80px auto;
        margin: 0px;
        margin-top: 15px;"
      >
        <ion-avatar style="justify-self: center; height: 55px; width: 55px" slot="start">
          <img [src]="app.iconURL | iconParse" />
        </ion-avatar>
        <div style="display: flex; flex-direction: column;">
          <ion-text style="font-family: 'Montserrat'; font-size: x-large; line-height: normal;" [class.less-large]="app.title.length > 20">
            {{ app.title }}
          </ion-text>
          <ion-text style="margin-top: -5px; margin-left: 2px;">
            {{ app.versionInstalled | displayEmver }}
          </ion-text>
        </div>
      </ion-label>
    </ion-item>

    <ion-item class="no-cushion-item" lines=none style="margin-bottom: 10px;">
      <ion-label class="status-readout">
        <status size="bold-large" [appStatus]="app.status"></status>
        <ion-button *ngIf="app.status === AppStatus.NEEDS_CONFIG" expand="block" fill="outline" [routerLink]="['config']">
          Configure
        </ion-button>
        <ion-button *ngIf="[AppStatus.RUNNING, AppStatus.CRASHED, AppStatus.PAUSED, AppStatus.RESTARTING] | includes: app.status" expand="block" fill="outline" color="danger" (click)="stop()">
          Stop
        </ion-button>
        <ion-button *ngIf="app.status === AppStatus.CREATING_BACKUP" expand="block" fill="outline" (click)="presentAlertStopBackup()">
          Stop Backup
        </ion-button>
        <ion-button *ngIf="app.status === AppStatus.DEAD" expand="block" fill="outline" (click)="uninstall()">
          Force Uninstall
        </ion-button>
        <ion-button *ngIf="app.status === AppStatus.BROKEN_DEPENDENCIES" expand="block" fill="outline" (click)="scrollToRequirements()">
          Fix
        </ion-button>
        <ion-button *ngIf="app.status === AppStatus.STOPPED" expand="block" fill="outline" color="success" (click)="tryStart()">
          Start
        </ion-button>
      </ion-label>
    </ion-item>

    <ion-button size="small" *ngIf="app.hasUI" [disabled]="!app.launchable" class="launch-button" expand="block" (click)="launchUiTab()">
      Launch Web Interface
      <ion-icon slot="end" name="rocket-outline"></ion-icon>
    </ion-button>

  </div>

  <ng-container *ngIf="app && app.id && app.status !== 'INSTALLING'">
    <ion-item-group class="ion-padding-bottom">
      <!-- addresses -->
      <ion-item>
        <ion-label class="ion-text-wrap">
          <h2>Tor Address</h2>
          <p>{{ app.torAddress }}</p>
        </ion-label>
        <ion-button slot="end" fill="clear" (click)="copyTor()">
          <ion-icon slot="icon-only" name="copy-outline" color="primary"></ion-icon>
        </ion-button>
      </ion-item>
      <ion-item lines="none">
        <ion-label class="ion-text-wrap">
          <h2>LAN Address</h2>
          <p *ngIf="!hideLAN">{{ app.lanAddress }}</p>
          <p *ngIf="hideLAN"><ion-text color="warning">No LAN address for {{ app.title }} {{ app.versionInstalled }}</ion-text></p>
        </ion-label>
        <ion-button *ngIf="!hideLAN" slot="end" fill="clear" (click)="copyLAN()">
          <ion-icon slot="icon-only" name="copy-outline" color="primary"></ion-icon>
        </ion-button>
      </ion-item>

      <!-- backups -->
      <ion-item-divider></ion-item-divider>
      <!-- create backup -->
      <ion-item button [disabled]="[AppStatus.RESTORING_BACKUP, AppStatus.CREATING_BACKUP, AppStatus.INSTALLING, AppStatus.RESTARTING, AppStatus.STOPPING] | includes: app.status" (click)="presentModalBackup('create')">
        <ion-icon slot="start" name="save-outline" color="primary"></ion-icon>
        <ion-label style="display: flex; flex-direction: column;">
          <ion-text color="primary">Create Backup</ion-text>
          <ion-text color="medium" style="font-size: x-small">
            Last Backup: {{app.lastBackup ? (app.lastBackup | date: 'short') : 'never'}}
          </ion-text>
        </ion-label>
      </ion-item>
      <!-- restore backup -->
      <ion-item lines="none" button [disabled]="[AppStatus.RESTORING_BACKUP, AppStatus.CREATING_BACKUP, AppStatus.INSTALLING, AppStatus.RESTARTING, AppStatus.STOPPING] | includes: app.status" (click)="presentModalBackup('restore')">
        <ion-icon slot="start" name="color-wand-outline" color="primary"></ion-icon>
        <ion-label><ion-text color="primary">Restore from Backup</ion-text></ion-label>
      </ion-item>

      <ion-item-divider></ion-item-divider>
      <!-- instructions -->
      <ion-item [routerLink]="['instructions']">
        <ion-icon slot="start" name="list-outline" color="primary"></ion-icon>
        <ion-label><ion-text color="primary">Instructions</ion-text></ion-label>
      </ion-item>
      <!-- config -->
      <ion-item [disabled]="[AppStatus.CREATING_BACKUP, AppStatus.RESTORING_BACKUP, AppStatus.INSTALLING, AppStatus.DEAD] | includes: app.status" [routerLink]="['config']">
        <ion-icon slot="start" name="construct-outline" color="primary"></ion-icon>
        <ion-label><ion-text color="primary">Config</ion-text></ion-label>
      </ion-item>
      <!-- metrics -->
      <ion-item [routerLink]="['metrics']">
        <ion-icon slot="start" name="information-circle-outline" color="primary"></ion-icon>
        <ion-label><ion-text color="primary">Properties</ion-text></ion-label>
      </ion-item>
      <!-- actions -->
      <ion-item [routerLink]="['actions']">
        <ion-icon slot="start" name="flash-outline" color="primary"></ion-icon>
        <ion-label><ion-text color="primary">Actions</ion-text></ion-label>
      </ion-item>
      <!-- logs -->
      <ion-item [disabled]="app.status === AppStatus.INSTALLING" [routerLink]="['logs']">
        <ion-icon slot="start" name="newspaper-outline" color="primary"></ion-icon>
        <ion-label><ion-text color="primary">Logs</ion-text></ion-label>
      </ion-item>
      <!-- marketplace -->
      <ion-item lines="none" [routerLink]="['/services', 'marketplace', appId]">
        <ion-icon slot="start" name="storefront-outline" color="primary"></ion-icon>
        <ion-label><ion-text color="primary">Marketplace Listing</ion-text></ion-label>
      </ion-item>

      <!-- dependencies -->
      <ng-container *ngIf="app.configuredRequirements && app.configuredRequirements.length">
        <ion-item-divider [id]="'service-requirements-' + app.id">Dependencies
          <ion-button style="position: relative; right: 10px;" size="small" fill="clear" color="medium"  (click)="presentPopover(dependencyDefintion(), $event)">
            <ion-icon name="help-circle-outline"></ion-icon>
          </ion-button>
        </ion-item-divider>
        <dependency-list [$loading$]="$loadingDependencies$" depType="installed" [hostApp]="app | peekProperties" [dependencies]="app.configuredRequirements"></dependency-list>
      </ng-container>

      <ion-item-divider></ion-item-divider>

      <ng-container *ngIf="app.status !== AppStatus.INSTALLING && app.status !== 'CREATING_BACKUP'">
        <!-- uninstall -->
        <ion-item style="--background: transparent" button (click)="uninstall()">
          <ion-icon slot="start" name="trash-outline" color="medium"></ion-icon>
          <ion-label><ion-text color="danger">Uninstall</ion-text></ion-label>
        </ion-item>
      </ng-container>
    </ion-item-group>
  </ng-container>
</ion-content>
